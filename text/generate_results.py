#!/usr/bin/env python

import os
import re
import sys

def findModel(*frags):
    rfrags = map(lambda x: re.compile(x), frags)
    res = []
    root = os.path.join(path, "ModelicaByExample")
    for ent in os.walk(root):
        for f in ent[2]:
            if f=="package.mo":
                continue
            match = True
            full = os.path.join(ent[0], f)
            rel = full[(len(root)+1):]
            modname = rel[:-3].replace("/",".")
            for rfrag in rfrags:
                if len(rfrag.findall(modname))==0:
                    match = False
            if match:
                res.append((full, rel, modname))
    if len(res)==1:
        return res[0]
    else:
        print "Unable to find a unique match for "+str(frags)+" matches include:"
        for r in res:
            print str(r)
        sys.exit(1)

def add_case(*frags, **kwargs):
    mod = findModel(*frags)
    data = kwargs.copy()
    data["name"] = mod[2]
    if not "short" in data:
        print "Error, not short hand name associated with pattern: "+str(frags)
        sys.exit(1)
    short = data["short"]
    if short in refs:
        print "Error, multiple cases using the same short hand name "+short
        sys.exit(1)
    refs[short] = data
    models.append(data)

class Var(object):
    def __init__(self, name, legend=None, style="-"):
        self.name = name
        self.style = style
        if legend==None:
            self.legend = name
        else:
            self.legend = legend
    def dict(self):
        return {"name": self.name, "legend": self.legend, "style": self.style}
    def __repr__(self):
        return repr(self.dict())

class SimplePlot(object):
    def __init__(self, short, model, vars, title=None, legloc="lower right", ylabel=""):
        self.short = short
        self.model = model
        self.vars = vars
        self.title = title
        self.legloc = legloc
        self.ylabel = ylabel
    def script(self):
        simplePlot = """
# Autogenerated script to plot results for model
# %s
from xogeny.plot_utils import render_simple_plot
render_simple_plot("%s", %s, title=%s, legloc=%s, ylabel=%s)
""";
        dotname = self.model["name"]
        short = self.short
        dashname = dotname.replace(".", "_")
        vars = map(lambda x: x.dict(), self.vars)
        return simplePlot % (dotname, short, vars,
                             repr(self.title), repr(self.legloc), repr(self.ylabel))

class ComparePlot(object):
    def __init__(self, short, model1, vars1, model2, vars2,
                 title=None, legloc="lower right", ylabel=""):
        self.short = short
        self.model1 = model1
        self.vars1 = vars1
        self.model2 = model2
        self.vars2 = vars2
        self.title = title
        self.legloc = legloc
        self.ylabel = ylabel
    def script(self):
        compPlot = """
# Autogenerated script to plot results for model
# %s
from xogeny.plot_utils import render_comp_plot
render_comp_plot("%s", %s, "%s", %s, title=%s, legloc=%s, ylabel=%s)
""";
        short = self.short
        dotname1 = self.model1["name"]
        dashname1 = dotname1.replace(".", "_")
        shortname1 = self.model1["short"]
        dotname2 = self.model2["name"]
        dashname2 = dotname2.replace(".", "_")
        shortname2 = self.model2["short"]
        vars1 = map(lambda x: x.dict(), self.vars1)
        vars2 = map(lambda x: x.dict(), self.vars2)
        return compPlot % (dotname1, shortname1, vars1, shortname2, vars2,
                           repr(self.title), repr(self.legloc), repr(self.ylabel))

def add_simple_plot(short, *vars, **kwargs):
    if short in refs:
        model = refs[short]
        key = kwargs.pop("key", short)
        if key in plots:
            print "Error, plot by the name of "+short+" already defined"
            sys.exit(1)
        plots[key] = SimplePlot(short, model, vars, **kwargs)
    else:
        print "Couldn't find model with shorthand name of "+short
        sys.exit(1)

def add_compare_plot(short1, v1, short2, v2, **kwargs):
    if not short1 in refs:
        print "Couldn't find model with shorthand name of "+short1
    if not short2 in refs:
        print "Couldn't find model with shorthand name of "+short2

    model1 = refs[short1]
    model2 = refs[short2]
    if short1 in plots:
        print "Error, plot by the name of "+short1+" already defined"
        sys.exit(1)
    plots[short1] = ComparePlot(short1, model1, v1, model2, v2, **kwargs)

models = []
plots = {}
refs = {}
path = os.path.abspath("..");
results = default=os.path.abspath("./results")

# This is the list of things I need to simulate

## Simple Examples
fovars = [Var("x", legend="x")]
add_case("SimpleExample", "FirstOrder$", stopTime=10,
         short="FO", vars=["x"]);
add_simple_plot("FO", *fovars, title="Simulation of FirstOrder")

focvars = [Var("x", legend="x (FirstOrder)")]
foivars = [Var("x", legend="x (FirstOrderInitial)")]
add_case("SimpleExample", "FirstOrderInitial", stopTime=10, short="FOI")
add_compare_plot("FOI", foivars, "FO", focvars, title="Specifying (non-zero) Initial Conditions")

fosvars = [Var("x", legend="x (FirstOrderSteady)")]
add_case("SimpleExample", "FirstOrderSteady", stopTime=10, short="FOS")
add_compare_plot("FOS", fosvars, "FO", focvars,
                 title="Steady State Solution (vs. Dynamic Response)")

## Cooling Example
add_case("NewtonCoolingWithDefaults", stopTime=1, short="NCWD")
add_simple_plot("NCWD", Var("T"), title="Cooling to Ambient",
                legloc="upper right", ylabel="Temperature")

## RLC
add_case("RLC1", stopTime=2, short="RLC1")
add_simple_plot("RLC1",
                Var("V", legend="Output Voltage [V]", style="-"),
                Var("Vb", legend="Battery Voltage [V]", style="-."),
                title="Circuit Response")

## RotationalSMD
sosvars = [Var("phi1", legend="Position of inertia 1 [rad]"),
           Var("phi2", legend="Position of inertia 2 [rad]"),
           Var("omega1", legend="Velocity of inertia 1 [rad/s]"),
           Var("omega2", legend="Velocity of inertia 2 [rad/s]")]
add_case("SecondOrderSystemInitParams", stopTime=5, short="SOSIP")
add_simple_plot("SOSIP", *sosvars, title="Mechanical System Response")

add_case("SecondOrderSystemInitParams", stopTime=5, short="SOSIP1",
         modes={"phi1": 1.0})
add_simple_plot("SOSIP1", *sosvars, title="Mechanical Response; phi1(0)=0")

## LotkaVolterra
lvvars = [Var("x", legend="Prey population"),
          Var("y", legend="Predator population")]

add_case("ClassicModel$", stopTime=140, short="LVCM")
add_simple_plot("LVCM", *lvvars, title="Classic Lotka-Volterra")

add_case("QuiescientModel$", stopTime=140, short="LVQM")
add_simple_plot("LVQM", *lvvars, title="Queiscient Model (trivial solution)")

add_case("QuiescientModelUsingStart", stopTime=140, short="LVQMUS")
add_simple_plot("LVQMUS", *lvvars,
                title="Queiscient Model (using start values)")

## Cooling Revisited
ncdvars = [Var("T", legend="Temperature"),
           Var("T_inf", legend="Ambient Temperature")]
add_case("NewtonCoolingDynamic", stopTime=1, short="NCD")
add_simple_plot("NCD", *ncdvars,
                title="Cooling to Time-Varying Ambient",
                legloc="upper right", ylabel="Temperature [K]")

add_case("NewtonCoolingSteadyThenDynamic", stopTime=1, short="NCSTD")
add_simple_plot("NCSTD", *ncdvars,
                title="Equilibrium Initialization",
                legloc="lower left", ylabel="Temperature [K]")

## Bouncing Ball
bbvars = [Var("h", legend="Height")]
add_case("\.BouncingBall$", stopTime=3, short="BB1")
add_simple_plot("BB1", *bbvars,
                title="Simple Bouncing Ball Model",
                legloc="upper right", ylabel="Height [m]")
add_case("\.BouncingBall$", stopTime=5, short="BB2")
add_simple_plot("BB2", *bbvars,
                title="Consequences of Numerical Event Detection",
                legloc="upper right", ylabel="Height [m]")

## Switched RLC
srlc_vvars = [Var("Vs", legend="Source Voltage [V]"),
              Var("V", legend="Response Voltage [V]")]
srlc_ivars = [Var("i_R", legend="Resistor Current [A]"),
              Var("i_C", legend="Capacitor Current [A]"),
              Var("i_L", legend="Inductor Current [A]")]
add_case("SwitchedRLC\.SwitchedRLC", stopTime=2, short="SRLC")
add_simple_plot("SRLC", *srlc_vvars,
                title="Switched RLC Voltage Response",
                legloc="lower right")
#add_simple_plot("SRLC", *srlc_ivars,
#                title="Switched RLC Current Response",
#                legloc="lower right")

def genPlotScripts():
    for model in models:
        short = model["short"]
        plot = plots[short]
        with open(os.path.join("plots", short+".py"), "w+") as fp:
            fp.write(plot.script())
            fp.close()

def genSimScript():
    preamble = """
    loadModel(ModelicaServices);
    loadModel(Modelica);
    setModelicaPath(getModelicaPath()+":"+"%s");
    loadModel(ModelicaByExample);
    """ % (path,)

    cmd = preamble

    for model in models:
        dotname = model["name"]
        stop_time = model["stopTime"]
        shortname = model["short"]
        dashname = dotname.replace(".", "_")
        mods = model.get("mods", {})
        modstr = ",".join(map(lambda x: x+"="+str(mods[x]), mods))

        if stop_time==None:
            cmd = cmd+"""
    simulate(ModelicaByExample.%s, tolerance=1e-3, numberOfIntervals=500, fileNamePrefix="%s");
    """ % (dotname, shortname)
        else:
            cmd = cmd+"""
    simulate(ModelicaByExample.%s, stopTime=%s, tolerance=1e-3, numberOfIntervals=500, fileNamePrefix="%s");
    """ % (dotname, stop_time, shortname)

    with open("simulateAll.mos", "w+") as fp:
        fp.write(cmd)

genSimScript()
genPlotScripts()
