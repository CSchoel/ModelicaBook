image: mtiller/book-builder

variables:
    GIT_SUBMODULE_STRATEGY: normal
    DOCKER_DRIVER: overlay2

cache:
    paths:
        - text/results
        - text/plots

# Needed because we want to run Docker inside our runner? (which is already
# runninign Docker)
services:
    - docker:dind

# TODO: Parallelize these
stages:
    - specs
    - results
    - image_deps
    - image_build
    - image_publish
    - docs_json
    - docs_ebooks
    - docs_pdf
    - docs_site
    - docs_html

generate_specs:
    stage: specs
    script:
        - (cd text; make specs)

generate_results:
    stage: results
    script:
        - (cd text; make results)
    artifacts:
        paths:
            - text/results/exes.tar.gz
            - text/plots

generate_json:
    stage: docs_json
    script:
        - (cd text; make json)
    artifacts:
        paths:
            - text/build/

generate_ebooks:
    stage: docs_ebooks
    script:
        - (cd text; make ebooks)
    artifacts:
        paths:
            - text/build/

generate_pdfs:
    stage: docs_pdf
    script:
        - (cd text; make pdf pdf-a4)
    artifacts:
        paths:
            - text/build/

generate_site:
    image: node:10-jessie
    stage: docs_site
    script:
        - make ng_site
    artifacts:
        paths:
            - nextgen/out

generate_html:
    stage: docs_html
    script:
        - (cd text; make dirhtml)
    artifacts:
        paths:
            - text/build/

fetch_image_deps:
    image: node:10-jessie
    stage: image_deps
    script:
        - make api_deps

build_image:
    image: docker:stable
    stage: image_build
    script:
        - (cd api; docker build -t mtiller/book-server .)

publish_image:
    image: docker:stable
    stage: image_publish
    script:
        - echo $DOCKER_PASS | docker login -e $DOCKER_EMAIL -u $DOCKER_USER --password-stdin
        - docker push mtiller/book-server
